# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: k3d-local
  description: Defense Unicorns k3d environment 
  version: '###ZARF_PKG_TMPL_ZARF_VERSION###'
  architecture: amd64
  authors: "@runyontr, @timblaktu"
  source: https://github.com/defenseunicorns/uds-package-dubbd/k3d/zarf-package-k3d
  vendor: Defense Unicorns
constants:
  - name: ZARF_VERSION
    value: "###ZARF_PKG_TMPL_ZARF_VERSION###"
  - name: DL_BASE_URL
    value: "###ZARF_PKG_TMPL_DL_BASE_URL###"
  - name: K3D_CLUSTER_NAME
    value: "###ZARF_PKG_TMPL_K3D_CLUSTER_NAME###"
  #- name: DL_VERSION_URL
  #  value: '###ZARF_PKG_TMPL_DL_BASE_URL###/###ZARF_PKG_TMPL_ZARF_VERSION###'
  #- name: INIT_FILENAME
  #  value: 'zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst'
  - name: INIT_COMPONENTS
    value: "###ZARF_PKG_TMPL_INIT_COMPONENTS###"
components:
  - name: k3d
    # TODO: generate description field from script docstring using something like:
    #       sed -n '/^#.*\$/,/^$/p' scripts/script.sh
    description: 'Create k3d cluster named ###ZARF_PKG_TMPL_K3D_CLUSTER_NAME###'
    required: true
    files:
      - source: scripts/k3d.sh
        target: k3d.sh
        executable: true
    actions:
      onDeploy:
        before:
          - cmd: ./k3d.sh
      onRemove:
        after:
          - cmd: 'k3d cluster delete ###ZARF_PKG_TMPL_K3D_CLUSTER_NAME###'
  - name: init
    description: 'Deploy (###ZARF_PKG_TMPL_INIT_COMPONENTS###) components of zarf init package ###ZARF_PKG_TMPL_ZARF_VERSION### to k3d cluster ###ZARF_PKG_TMPL_K3D_CLUSTER_NAME###'
    required: true
    files:
      - source: init
        target: init
      # Manually fetch init pkg
      # - source: '###ZARF_PKG_TMPL_DL_BASE_URL###/###ZARF_PKG_TMPL_ZARF_VERSION###/zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst'
      #   target: 'zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst'
      # - source: '###ZARF_PKG_TMPL_DL_BASE_URL###/###ZARF_PKG_TMPL_ZARF_VERSION###/checksums.txt'
      #   target: 'checksums.txt'
    actions:
      onCreate:
        before:
          - cmd: ./zarf tools download-init -o init
        # after:
        #   - cmd: rm -rf init        
#         # Manually fetch init pkg
#         before:
#           - cmd: |
#               # wget ###ZARF_PKG_TMPL_DL_BASE_URL###/###ZARF_PKG_TMPL_ZARF_VERSION###/{checksums.txt,zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst}
#               test "$(sha256sum zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst)" = "$(grep --color=NEVER zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst checksums.txt)"
      onDeploy:
        after: 
          - cmd: 'zarf package deploy zarf-init-###ZARF_PKG_ARCH###-###ZARF_PKG_TMPL_ZARF_VERSION###.tar.zst --components ###ZARF_PKG_TMPL_INIT_COMPONENTS### --confirm -l warn'
  - name: metallb
    required: true
    files:
      - source: scripts/metallb.sh
        target: metallb.sh
        executable: true
    actions:
      onDeploy:
        after:
          - cmd: ./metallb.sh
    manifests:
      - name: metallb
        files:
          - manifests/metallb/metallb-native.yaml
    images:
      - quay.io/metallb/controller:v0.13.9
      - quay.io/metallb/speaker:v0.13.9
