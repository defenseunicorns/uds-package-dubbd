## [Cert Manager](https://cert-manager.io/)

"cert-manager is a powerful and extensible X.509 certificate controller for Kubernetes and OpenShift workloads. It will obtain certificates from a variety of Issuers, both popular public Issuers as well as private Issuers, and ensure the certificates are valid and up-to-date, and will attempt to renew certificates at a configured time before expiry." -- cert-manager.io

### Install

UDS installs cert-manager (controller, webhook, and cainjector) as a helm release, using images from Ironbank.

### Controlling Values

You can set different cert-manager values via `cert-manager.yaml` under the [values/ dir](../values/). It's important to keep `installCRDs: true`, unless you want to manually install them yourself via `kubectl` after the fact.

You can find a list of configurable values at [artifcathub.io](https://artifacthub.io/packages/helm/cert-manager/cert-manager).

### How to Create Custom Issuers and Certificates

Once the `cert-manager-chart` component is deployed and cert-manager is installed, the next component that needs to run is `cert-manager-custom-resources`, which will apply your manifest for your Issuer/ClustIssuer and any Certificates. This component looks for a manifest file passed to `###ZARF_VAR_CERT_RESOURCES###`. The default file it looks for in the **current directory** is `deploy-cert-resources.yaml`. You can change this by passing a different name to `cert_resources` in your `zarf-config.yaml`. Zarf will take this file and dump it's contents into the `cert-manager-resources.yaml` in [values/](../values/cert-manager-resources.yaml). It will then apply this file and deploy your cert-manager resources.

_You can manually create resources like Issuers and Certificates. However, in the case of securing Istio gateways it's better if the secrets generated by cert-manager exist before Big Bang deploys._

### Securing Istio Gateways

There are two ways now to secure istio gateways in DUBBD:

1. Pass key and cert files to zarf. By default DUBBD ingests the bigbang.dev.cert and bigbang.dev.key as cert_file and key_file. You can pass a different cert and key for admin purposes as well. If not given a specific admin cert and key, DUBBD will use cert_file and key_file for securing admin reesources as well. ([distro config](../defense-unicorns-distro/zarf.yaml)). The `load-certs` component in [Distro Zarf Yaml](../defense-unicorns-distro/zarf.yaml) will take these files and set them as the values for `###ZARF_VAR_PUBLIC_KEY###` and `###ZARF_VAR_PUBLIC_CERT`. Those variables are then used in [Istio Values](../values/istio.yaml) under the `gateways` tls section. Under the hood, Big Bang takes the key and cert and creates secrets for each gateway as `<gatewayname>-cert`, which get passed to Istio as the `gateways.tls.credentialName` values.

2. Use cert-manager to create certificates, which get stored as secrets, and pass them to Istio. To do this you will need to:
   1. Create your cert-manager Issuer and 2 certificates (see section on creating custom cert-manager resources). **One certificate secret needs to be named `admin-cert` (i.e. `secretName: admin-cert`) and the other `tenant-cert` (i.e. `secretName: tenant-cert`). This is a hack right now for getting around the fact that Big Bang does not directly expose `gateways.tls.credentialName`.** (i.e. [k3d custom resources](../k3d/deploy-cert-resources.yaml#L42))


### Run with K3D

If you'd like to run DUBBD with cert-manager locally and experiment with creating cert-manager custom resources, either uncomment [k3d/deploy-cert-resources.yaml](../k3d/deploy-cert-resources.yaml), which is a simple self-signed bootstrapped CA that issues certificates for the admin and tenant gateways, or replace with a completly custom solution.
